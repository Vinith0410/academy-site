const express = require("express")
const path = require("path")
const bcryptjs = require("bcryptjs")
const mongoose = require("mongoose")
const multer = require("multer")
const fs = require("fs")
const User = require("./models/User")
const Course = require("./models/course")
const session = require("express-session")
const Application = require("./models/application")
const Contact = require("./models/contact")
const nodemailer = require("nodemailer");
require("dotenv").config()



const app = express()


app.use(express.json())
app.use(express.urlencoded({extended:true}))
app.use(express.static(path.join(__dirname, "public")))


// session create
app.use(session({
  secret:"my-secret",
  resave:false,
  saveUninitialized:false
}))

// mongo db connection
mongoose.connect(process.env.MONGODB_URI)
.then(()=>{
  console.log("database connected")
})
.catch(()=>{
  console.log("database not connected")
})

//mail
const transporter = nodemailer.createTransport({
  host: "smtp.gmail.com",
  port: 587,
  secure: false, // IMPORTANT for 587
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASS
  },
  tls: {
    rejectUnauthorized: false
  }
});

// Simple email format validator
const isValidEmail = (email) => {
  if (!email || typeof email !== 'string') return false;
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email.trim());
};


// image upload
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'public/uploads/');
  },
  filename: (req, file, cb) => {
    cb(null, Date.now() + path.extname(file.originalname));
  }
});
const upload = multer({ storage: storage });

// admin routes
app.get('/loginform', (req,res)=>{
res.sendFile(path.join(__dirname,"./public/admin/auth/login.html"))
})
// app.get("/register", (req,res)=>{
// res.sendFile(path.join(__dirname,"./public/admin/auth/register.html"))
// })

app.get("/admin/courses", (req,res)=>{
  if(!req.session.userid){
    return res.send(`
      <script>
        alert("Please login first")
        window.location.href = "/"
      </script>
    `)
  }
res.sendFile(path.join(__dirname,"./public/admin/pages/courses.html"))
})

app.get("/admin/courses/add", (req,res)=>{
  if(!req.session.userid){
    return res.send(`
      <script>
        alert("Please login first")
        window.location.href = "/"
      </script>
    `)
  }
res.sendFile(path.join(__dirname,"./public/admin/pages/add-courses.html"))
})

app.get("/admin/courses/edit", (req,res)=>{
  if(!req.session.userid){
    return res.send(`
      <script>
        alert("Please login first")
        window.location.href = "/"
      </script>
    `)
  }
res.sendFile(path.join(__dirname,"./public/admin/pages/edit.html"))
})

// public routes
app.get('/', (req,res)=>{
res.sendFile(path.join(__dirname,"./public/home/index.html"))
})

app.get('/about', (req,res)=>{
res.sendFile(path.join(__dirname,"./public/about/index.html"))
})

app.get('/courses', (req,res)=>{
res.sendFile(path.join(__dirname,"./public/courses/index.html"))
})

app.get('/event', (req,res)=>{
res.sendFile(path.join(__dirname,"./public/event/index.html"))
})

app.get('/bootcamp', (req,res)=>{
res.sendFile(path.join(__dirname,"./public/bootcamp/index.html"))
})

app.get('/contact', (req,res)=>{
res.sendFile(path.join(__dirname,"./public/contact/index.html"))
})

// admin login
app.post("/admin/auth/login", async (req,res)=>{
  const {email, password} = req.body
  const user = await User.findOne({email})
  if(!user){
    return res.send(`
      <script>
        alert("User not found")
        window.location.href = "/"
      </script>
    `)
  }
  const isPasswordValid = await bcryptjs.compare(password, user.password)
  if(isPasswordValid){
    req.session.userid = user._id
  res.send(`
    <script>
      alert("Login successful")
      window.location.href = "/admin/courses"
    </script>
  `)
  }else{
    return res.send(`
      <script>
        alert("wrong password")
        window.location.href = "/"
      </script>
    `)
  }
})

//admin logout
app.get("/admin/auth/logout", (req,res)=>{
  req.session.destroy()
  res.send(`
    <script>
      alert("Logout successful")
      window.location.href = "/"
    </script>
  `)
})

// admin register
// app.post("/admin/auth/register", async (req,res)=>{
//   const {name, email, password} = req.body
//   // console.log(name, email, password)
//   const hashedPassword = await bcryptjs.hash(password, 10)
//   // console.log(hashedPassword)
//   const user = new User({name, email, password:hashedPassword})
//   await user.save()
//   res.send("User registered successfully")
// })

// course data store
app.post("/admin/courses/add", upload.single('img'), async (req,res)=>{
  if(!req.session.userid){
    return res.send(`
      <script>
        alert("Please login first")
        window.location.href = "/"
      </script>
    `)
  }
  const {name, price, oldPrice, duration, tag, desc} = req.body
  const image = req.file ? req.file.filename : null;
  const point = req.body.points.split(',').map(point => point.trim());
  if(!image){
    return res.send(`
      <script>
        alert("Please upload an image for the course")
        window.location.href = "/admin/courses/add"
      </script>
    `)
  }
  try{
    const course = new Course({name, price, oldPrice, duration, img:image, tag, desc, points:point})
    await course.save()
    res.send(`
      <script>
        alert("Course added successfully")
        window.location.href = "/admin/courses"
      </script>
    `)
  }catch(err){
    console.error(err)
    res.send(`
      <script>
        alert("Failed to add course:", err)
        window.location.href = "/admin/courses/add"
      </script>
    `)
  }
})

// get all courses
app.get("/admin/courses/data", async (req,res)=>{
  const courses = await Course.find()
  res.json(courses)
})

//get data
app.get("/admin/courses/data/:id" , async(req,res)=>{
  if(!req.session.userid){
    return res.send(`
      <script>
        alert("Please login first")
        window.location.href = "/"
      </script>
    `)
  }
  const id = req.params.id
  const course = await Course.findById(id)
  res.json(course)
})

// edit or update
app.post("/admin/courses/update", upload.single('img'), async (req,res)=>{
const {id, name, price, oldPrice, duration, tag, desc} = req.body
let image;
if(!id){
  return res.send(`
    <script>
      alert("Please provide a course ID")
      window.location.href = "/admin/courses"
    </script>
  `)
}else{
  const course = await Course.findById(id)
  if(!course){
    return res.send(`
      <script>
        alert("Course not found")
        window.location.href = "/admin/courses"
      </script>
    `)
  }
  // console.log(course.img)
  if(req.file){
     const imagepath = path.join(__dirname, "public/uploads", course.img);
    if(fs.existsSync(imagepath)){
      fs.unlinkSync(imagepath)
    }
    image = req.file.filename;
  }else{
    image = course.img;
  }
}
const point = req.body.points.split(',').map(point => point.trim());
try{
  await Course.findByIdAndUpdate(id, {name, price, oldPrice, duration, img:image, tag, desc, points:point})
  res.send(`
    <script>
      alert("Course updated successfully")
      window.location.href = "/admin/courses"
    </script>
  `)
}catch(err){
  console.error(err)
  res.send(`
    <script>
      alert("Failed to update course: ${err && err._message ? err._message : 'Validation error'}")
      window.location.href = "/admin/courses"
    </script>
  `)
}
})

// delete
app.delete("/admin/courses/delete/:id", async (req,res)=>{
  if(!req.session.userid){
    return res.send(`
      <script>
        alert("Please login first")
        window.location.href = "/"
      </script>
    `)
  }
  const id = req.params.id
  try{
    const course = await Course.findById(id)
    if(!course){
      return res.send(`
        <script>
          alert("Course not found")
          window.location.href = "/admin/courses"
        </script>
      `)
    }
    const imagepath = path.join(__dirname, "public/uploads", course.img);
    if(fs.existsSync(imagepath)){
      fs.unlinkSync(imagepath)
    }
    await Course.findByIdAndDelete(id)
    res.send(`
      <script>
        alert("Course deleted successfully")
        window.location.href = "/admin/courses"
      </script>
    `)
  }catch(err){
    console.error(err)
    res.send(`
      <script>
        alert("Failed to delete course:", err)
        window.location.href = "/admin/courses"
      </script>
    `)
  }
})

// serve PDFs with correct MIME type
app.get('/pdfs/:filename', (req, res) => {
  const filename = req.params.filename;
  const filepath = path.join(__dirname, 'public/courses/pdfs', filename);
  res.setHeader('Content-Type', 'application/pdf');
  res.setHeader('Content-Disposition', `attachment; filename="${filename}"`);
  res.sendFile(filepath, (err) => {
    if (err) {
      console.error('Error sending PDF:', err);
      res.status(404).json({ error: 'PDF not found' });
    }
  });
});


// event application submit
app.post("/event/apply", async (req, res) => {
  const { name, email, phone, programType, title } = req.body;

  try {
    // 1. Save to DB
    const application = new Application({
      name,
      email,
      phone,
      programType,
      programTitle: title
    });
    await application.save();

    // 2. USER EMAIL (await - important)
    await transporter.sendMail({
      from: `"Bright Future Academy" <${process.env.EMAIL_USER}>`,
      to: email,
      subject: "Thank You for Registering â€“ Your Journey Begins ðŸš€",
      html: `
        <p>Dear <strong>${name}</strong>,</p>
        <p>Thank you for registering for <strong>${title}</strong>.</p>
        <p>
          You have taken a powerful step toward your future.
          Our team will contact you shortly.
        </p>
        <p>
          <strong>Bright Future Academy Team</strong>
        </p>
      `
    });

    // 3. SEND RESPONSE IMMEDIATELY (FAST UX)
    res.json({
      success: true,
      message: "Application submitted successfully"
    });

    // 4. ADMIN EMAIL (background - no await)
    transporter.sendMail({
      from: `"Bright Future Academy" <${process.env.EMAIL_USER}>`,
      to: "vinithvinith35614@gmail.com",
      subject: "ðŸ“© New Registration Alert",
      html: `
        <h3>New Event Registration</h3>
        <p><strong>Name:</strong> ${name}</p>
        <p><strong>Email:</strong> ${email}</p>
        <p><strong>Phone:</strong> ${phone}</p>
        <p><strong>Program:</strong> ${title}</p>
        <p><strong>Type:</strong> ${programType}</p>
        <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
      `
    }).catch(err => {
      console.error("Admin mail failed:", err);
    });

  } catch (err) {
    console.error(err);
    res.json({
      success: false,
      message: "Failed to submit application"
    });
  }
});

// Contact form endpoint: save message and send confirmation email
app.post('/contact', async (req, res) => {
  const { name, email, phone, message } = req.body;

  // Basic validation
  if (!name || !email || !message) {
    return res.status(400).json({ success: false, message: 'Name, email and message are required' });
  }
  if (!isValidEmail(email)) {
    return res.status(400).json({ success: false, message: 'Invalid email format' });
  }

  try {
    // Save to DB
    const contact = new Contact({ name, email, phone, message });
    await contact.save();

    // Send confirmation email to user
    try {
      await transporter.sendMail({
        from: `"Bright Future Academy" <${process.env.EMAIL_USER}>`,
        to: email,
        subject: 'We received your message â€” Bright Future Academy',
        html: `
          <p>Hi <strong>${name}</strong>,</p>
          <p>Thanks for reaching out to Bright Future Academy. We received your message:</p>
          <blockquote>${message}</blockquote>
          <p>Our team will reply shortly. If you need urgent assistance, call +91 9087315789.</p>
          <p><strong>â€” Bright Future Academy Team</strong></p>
        `
      });
    } catch (mailErr) {
      console.error('Contact user mail failed:', mailErr.message || mailErr);
      return res.status(500).json({ success: false, message: 'Message saved but confirmation email failed to send' });
    }

    // Send admin notification (background)
    transporter.sendMail({
      from: `"Bright Future Academy" <${process.env.EMAIL_USER}>`,
      to: 'vinithvinith35614@gmail.com',
      subject: 'New contact message received',
      html: `
        <h3>New Contact Message</h3>
        <p><strong>Name:</strong> ${name}</p>
        <p><strong>Email:</strong> ${email}</p>
        <p><strong>Phone:</strong> ${phone || 'N/A'}</p>
        <p><strong>Message:</strong><br/>${message}</p>
        <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
      `
    }).catch(err => console.error('Admin contact mail failed:', err && err.message ? err.message : err));

    res.json({ success: true, message: 'Message sent successfully' });
  } catch (err) {
    console.error('Contact save error:', err);
    res.status(500).json({ success: false, message: 'Failed to send message. Please try again.' });
  }
});

app.post("/apply", async (req, res) => {
  const { fullName, email, phone, programType, title } = req.body;

  try {
    // 1. Save to DB
    await new Application({
      name: fullName,
      email,
      phone,
      programType,
      programTitle: title
    }).save();

    // 2. USER EMAIL (await)
    await transporter.sendMail({
      from: `"Bright Future Academy" <${process.env.EMAIL_USER}>`,
      to: email,
      subject: "Thank You for Registering â€“ Your Journey Begins ðŸš€",
      html: `
        <p>Dear <strong>${fullName}</strong>,</p>
        <p>Thank you for registering for <strong>${title}</strong>.</p>
        <p>Our team will contact you shortly.</p>
        <p><strong>Bright Future Academy Team</strong></p>
      `
    });

    // 3. Respond immediately
    res.json({ success: true, message: "Application submitted successfully" });

    // 4. ADMIN EMAIL (background)
    transporter.sendMail({
      from: `"Bright Future Academy" <${process.env.EMAIL_USER}>`,
      to: "vinithvinith35614@gmail.com",
      subject: "ðŸ“© New Course Registration",
      html: `
        <h3>New Course Registration</h3>
        <p><b>Name:</b> ${fullName}</p>
        <p><b>Email:</b> ${email}</p>
        <p><b>Phone:</b> ${phone}</p>
        <p><b>Course:</b> ${title}</p>
        <p><b>Type:</b> ${programType}</p>
        <p><b>Time:</b> ${new Date().toLocaleString()}</p>
      `
    }).catch(console.error);

  } catch (err) {
    console.error(err);
    res.status(500).json({ success: false, message: "Failed to submit application" });
  }
});


app.listen(4000, ()=>{
console.log("server is running on http://localhost:4000")
})
