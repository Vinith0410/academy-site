<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Certificates List</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif;
    }

    body {
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      margin: 0;
      color: #27ae60;
    }

    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .filter-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .filter-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-group label {
      font-weight: bold;
      color: #555;
      font-size: 14px;
    }

    .filter-group select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      transition: 0.3s;
    }

    .filter-group select:hover {
      border-color: #27ae60;
    }

    .filter-group select:focus {
      outline: none;
      border-color: #27ae60;
      box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.1);
    }

    .btn-reset {
      padding: 10px 20px;
      background: #95a5a6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }

    .btn-reset:hover {
      background: #7f8c8d;
    }

    .btn-add {
      padding: 10px 20px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-add:hover {
      background: #1e8449;
    }

    .table-wrapper {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #2ecc71;
      color: white;
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: bold;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid #ecf0f1;
    }

    tbody tr:hover {
      background: #f8f9fa;
    }

    .qr-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-width: 150px;
    }

    .qr-img {
      width: 100px;
      height: 100px;
      object-fit: contain;
      cursor: pointer;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 13px;
      transition: 0.3s;
    }

    .btn-download {
      background: #3498db;
      color: white;
    }

    .btn-download:hover {
      background: #2980b9;
    }

    .btn-edit {
      background: #f39c12;
      color: white;
    }

    .btn-edit:hover {
      background: #e67e22;
    }

    .btn-delete {
      background: #e74c3c;
      color: white;
    }

    .btn-delete:hover {
      background: #c0392b;
    }

    .btn-view {
      background: #27ae60;
      color: white;
    }

    .btn-view:hover {
      background: #1e8449;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #555;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }

    .empty {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal-header {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-cancel {
      background: #95a5a6;
      color: white;
    }

    .btn-cancel:hover {
      background: #7f8c8d;
    }

    .btn-confirm {
      background: #e74c3c;
      color: white;
    }

    .btn-confirm:hover {
      background: #c0392b;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 8px;
      }

      .qr-img {
        width: 70px;
        height: 70px;
      }

      button {
        padding: 6px 10px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìú All Certificates</h1>
      <a href="/Certificate/add-Certificate" class="btn-add">+ Add Certificate</a>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-title">üîç Filter Certificates</div>
      <div class="filter-controls">
        <div class="filter-group">
          <label for="filterCourseType">Course Type:</label>
          <select id="filterCourseType" onchange="applyFilters()">
            <option value="">All Types</option>
            <option value="course">Course</option>
            <option value="bootcamp">Bootcamp</option>
            <option value="special-event">Special Event</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="filterCourse">Course:</label>
          <select id="filterCourse" onchange="applyFilters()">
            <option value="">All Courses</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="filterBatch">Batch:</label>
          <select id="filterBatch" onchange="applyFilters()">
            <option value="">All Batches</option>
          </select>
        </div>

        <button class="btn-reset" onclick="resetFilters()">Reset Filters</button>
      </div>
    </div>

    <div id="errorMsg" class="error" style="display:none;"></div>

    <div class="table-wrapper">
      <div id="loading" class="loading">
        <p>Loading certificates...</p>
      </div>

      <div id="tableContent"></div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal" id="deleteModal">
    <div class="modal-content">
      <div class="modal-header">‚ö†Ô∏è Delete Certificate</div>
      <div class="modal-body">
        <p>Are you sure you want to delete this certificate? This action cannot be undone.</p>
        <p><strong id="certNameToDelete"></strong></p>
      </div>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn-confirm" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script>
    let allCertificates = [];
    let certificateToDelete = null;

    async function loadCertificates() {
      try {
        const response = await fetch('/Certificate/list');

        if (!response.ok) {
          throw new Error('Failed to load certificates');
        }

        allCertificates = await response.json();

        if (allCertificates.length === 0) {
          document.getElementById('tableContent').innerHTML = '<div class="empty"><p>No certificates found</p></div>';
          document.getElementById('loading').style.display = 'none';
          return;
        }

        populateFilterOptions();
        renderTable(allCertificates);
        document.getElementById('loading').style.display = 'none';
      } catch (error) {
        document.getElementById('errorMsg').textContent = `Error: ${error.message}`;
        document.getElementById('errorMsg').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
      }
    }

    function populateFilterOptions() {
      const courseSet = new Set();
      const batchSet = new Set();

      allCertificates.forEach(cert => {
        if (cert.course) courseSet.add(cert.course);
        if (cert.batch) batchSet.add(cert.batch);
      });

      // Populate Course filter
      const courseSelect = document.getElementById('filterCourse');
      Array.from(courseSet).sort().forEach(course => {
        const option = document.createElement('option');
        option.value = course;
        option.textContent = course;
        courseSelect.appendChild(option);
      });

      // Populate Batch filter
      const batchSelect = document.getElementById('filterBatch');
      Array.from(batchSet).sort().forEach(batch => {
        const option = document.createElement('option');
        option.value = batch;
        option.textContent = batch;
        batchSelect.appendChild(option);
      });
    }

    function applyFilters() {
      const courseType = document.getElementById('filterCourseType').value;
      const course = document.getElementById('filterCourse').value;
      const batch = document.getElementById('filterBatch').value;

      const filtered = allCertificates.filter(cert => {
        const matchCourseType = !courseType || cert.coursetype === courseType;
        const matchCourse = !course || cert.course === course;
        const matchBatch = !batch || cert.batch === batch;

        return matchCourseType && matchCourse && matchBatch;
      });

      if (filtered.length === 0) {
        document.getElementById('tableContent').innerHTML = '<div class="empty"><p>No certificates match your filters</p></div>';
      } else {
        renderTable(filtered);
      }
    }

    function resetFilters() {
      document.getElementById('filterCourseType').value = '';
      document.getElementById('filterCourse').value = '';
      document.getElementById('filterBatch').value = '';
      renderTable(allCertificates);
    }

    function renderTable(certificates) {
      let html = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Student ID</th>
              <th>Course</th>
              <th>Batch</th>
              <th>QR Code</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      certificates.forEach(cert => {
        html += `
          <tr>
            <td><strong>${cert.name}</strong></td>
            <td>${cert.studentid}</td>
            <td>${cert.course}</td>
            <td>${cert.batch}</td>
            <td>
              <div class="qr-container">
                <img src="/uploads/qrcode/${cert._id}.png" alt="QR" class="qr-img" title="Click to download">
                <button onclick="downloadQR('${cert._id}')" style="display:none;" id="btn-qr-${cert._id}"></button>
              </div>
            </td>
            <td>
              <div class="actions">
                <button class="btn-view" onclick="viewCertificate('${cert._id}')">View</button>
                <button class="btn-download" onclick="downloadQR('${cert._id}')">DL QR</button>
                <button class="btn-edit" onclick="editCertificate('${cert._id}')">Edit</button>
                <button class="btn-delete" onclick="openDeleteModal('${cert._id}', '${cert.name}')">Delete</button>
              </div>
            </td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      document.getElementById('tableContent').innerHTML = html;
    }

    function viewCertificate(id) {
      window.location.href = `/Certificate/details/${id}`;
    }

    function downloadQR(id) {
      const qrImg = document.querySelector(`img[src="/uploads/qrcode/${id}.png"]`);

      fetch(`/uploads/qrcode/${id}.png`)
        .then(response => response.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `certificate-qr-${id}.png`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        })
        .catch(error => {
          console.error('Error downloading QR:', error);
          alert('Failed to download QR code');
        });
    }

    function editCertificate(id) {
      window.location.href = `/Certificate/edit/${id}`;
    }

    function openDeleteModal(id, name) {
      certificateToDelete = id;
      document.getElementById('certNameToDelete').textContent = name;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
      certificateToDelete = null;
    }

    function confirmDelete() {
      if (!certificateToDelete) return;

      fetch(`/Certificate/delete/${certificateToDelete}`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          closeDeleteModal();
          alert('Certificate deleted successfully');
          loadCertificates();
        } else {
          alert(`Error: ${result.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete certificate');
      });
    }

    // Load certificates on page load
    document.addEventListener('DOMContentLoaded', loadCertificates);
  </script>
</body>
</html>
